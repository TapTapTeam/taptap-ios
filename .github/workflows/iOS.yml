name: iOS CI/CD

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: Create xcconfig file
      run: |
        mkdir -p TapTap/Tuist/Config
        echo "${{ secrets.PROJECT_XCCONFIG_CONTENT }}" >TapTap/Tuist/Config/Project.xcconfig
    - name: Set up App Store Connect API
      env:
        ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$ASC_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8
        echo "ASC_KEY_FILEPATH=$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8" >> $GITHUB_ENV
    - name: Setup Git Auth
      run: |
        git config --global url."https://${{ secrets.MATCH_GIT_BASIC_AUTH}}@github.com/".insteadOf "https://github.com/"
   
    - name: Fastlane
      working-directory: TapTap
      env:
        ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
        ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        BUNDLE_GEMFILE: ../Gemfile
        ASC_KEY_FILEPATH: ${{ env.ASC_KEY_FILEPATH }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_BASIC_AUTH: ${{ secrets.MATCH_GIT_BASIC_AUTH }}
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tag/v}
          bundle exec fastlane ios ci_release version:$VERSION
        else
          bundle exec fastlane ios ci_beta
        fi
