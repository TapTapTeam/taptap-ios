require 'json'

default_platform(:ios)

platform :ios do
    lane :dev do
        match(
            type: "development",
            app_identifier: [
                "com.Nbs.dev.app",
                "com.Nbs.dev.app.safariExtension",
                "com.Nbs.dev.app.shareExtension",
            ],
            platform: "ios"
        )
    end

    lane :release do
        match(
            type: "appstore",
            app_identifier: [
                "com.Nbs.dev.ADA.app",
                "com.Nbs.dev.ADA.app.safariExtension",
                "com.Nbs.dev.ADA.app.actionExtension",
            ],
            platform: "ios"
        )
    end
  
  desc "TesetFlight ì—…ë¡œë“œ(ë²„ì „ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.)"
  lane :beta do |options|
    version = options[:version] || prompt(text: "ë²„ì „ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1.10.0): ")

    release

    app_identifier = "com.Nbs.dev.ADA.app"
    next_build = latest_testflight_build_number(app_identifier: app_identifier, version: version).to_i + 1

    xcconfig_path = File.expand_path("../../Tuist/Config/Project.xcconfig", __FILE__)
    content = File.read(xcconfig_path)

    content = content.gsub(/^MARKETING_VERSION\s*=\s*.*$/, "MARKETING_VERSION = #{version}")
    content = content.gsub(/^CURRENT_PROJECT_VERSION\s*=\s*.*$/, "CURRENT_PROJECT_VERSION = #{next_build}")

    File.write(xcconfig_path, content)

    build_app(
      workspace: "../TapTap/TapTap.xcworkspace",
      scheme: "TapTap",
      export_method: "app-store"
    )

    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_KEY_FILEPATH"]
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      username: ENV["APPLE_ID"]
    )

    notify_discord(
      title: "ğŸš€ TestFlight ì—…ë¡œë“œ ì™„ë£Œ",
      message: "ìƒˆë¡œìš´ ë² íƒ€ ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\në²„ì „: #{version} (#{next_build})",
      color: 377472
    )
  end

  desc "App Store ë°°í¬ (ë²„ì „ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.)"
  lane :appstore do |options|
    version = options[:version] || prompt(text: "ë°°í¬í•  ë²„ì „ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1.10.0): ")

    release

    app_identifier = "com.Nbs.dev.ADA.app"
    next_build = latest_testflight_build_number(app_identifier: app_identifier, version: version).to_i + 1

    xcconfig_path = File.expand_path("../../Tuist/Config/Project.xcconfig", __FILE__)
    content = File.read(xcconfig_path)

    content = content.gsub(/^MARKETING_VERSION\s*=\s*.*$/, "MARKETING_VERSION = #{version}")
    content = content.gsub(/^CURRENT_PROJECT_VERSION\s*=\s*.*$/, "CURRENT_PROJECT_VERSION = #{next_build}")

    File.write(xcconfig_path, content)

    build_app(
      workspace: "../TapTap/TapTap.xcworkspace",
      scheme: "TapTap",
      export_method: "app-store"
    )

    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_KEY_FILEPATH"]
    )

    upload_to_app_store(
      api_key: api_key,
      app_identifier: "com.Nbs.dev.ADA.app",
      app_version: version,
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false,
      run_precheck_before_submit: false
    )

    notify_discord(
      title: "ğŸ“¦ App Store ì œì¶œ ì™„ë£Œ",
      message: "ì•±ì´ ì„±ê³µì ìœ¼ë¡œ App Store Connectì— ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\në²„ì „: #{version} (#{next_build})",
      color: 6377978
    )
  end

  desc "CIìš© TestFlight ì—…ë¡œë“œ (ë¹Œë“œ ë²ˆí˜¸ë§Œ ìë™ ì—…ë°ì´íŠ¸)"
  lane :ci_beta do
    setup_ci
    app_identifier = "com.Nbs.dev.ADA.app"
    
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_KEY_FILEPATH"]
    )

    match(type: "appstore", readonly: true, app_identifier: ["com.Nbs.dev.ADA.app", "com.Nbs.dev.ADA.app.safariExtension", "com.Nbs.dev.ADA.app.actionExtension"])

    next_build = latest_testflight_build_number(
      app_identifier: app_identifier,
      api_key: api_key
    ).to_i + 1

    xcconfig_path = File.expand_path("../../Tuist/Config/Project.xcconfig", __FILE__)
    content = File.read(xcconfig_path)
    content = content.gsub(/^CURRENT_PROJECT_VERSION\s*=\s*.*$/, "CURRENT_PROJECT_VERSION = #{next_build}")
    File.write(xcconfig_path, content)

    build_app(workspace: "../TapTap/TapTap.xcworkspace", scheme: "TapTap", export_method: "app-store")
    
    upload_to_testflight(api_key: api_key, skip_waiting_for_build_processing: true)

    notify_discord(
      title: "ğŸš€ [CI] TestFlight ì—…ë¡œë“œ ì™„ë£Œ",
      message: "CIë¥¼ í†µí•œ ë² íƒ€ ë¹Œë“œ ì—…ë¡œë“œê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.\në¹Œë“œ ë²ˆí˜¸: #{next_build}",
      color: 377472
    )
  end

  desc "CIìš© App Store ë°°í¬ (íƒœê·¸ ë²„ì „ ì‚¬ìš©)"
  lane :ci_release do |options|
    setup_ci
    version = options[:version] || UI.user_error!("ë²„ì „ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    app_identifier = "com.Nbs.dev.ADA.app"

    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_KEY_FILEPATH"]
    )

    match(type: "appstore", readonly: true, app_identifier: ["com.Nbs.dev.ADA.app", "com.Nbs.dev.ADA.app.safariExtension", "com.Nbs.dev.ADA.app.actionExtension"])

    next_build = latest_testflight_build_number(
      app_identifier: app_identifier,
      api_key: api_key,
      version: version
    ).to_i + 1

    xcconfig_path = File.expand_path("../../Tuist/Config/Project.xcconfig", __FILE__)
    content = File.read(xcconfig_path)
    content = content.gsub(/^MARKETING_VERSION\s*=\s*.*$/, "MARKETING_VERSION = #{version}")
    content = content.gsub(/^CURRENT_PROJECT_VERSION\s*=\s*.*$/, "CURRENT_PROJECT_VERSION = #{next_build}")
    File.write(xcconfig_path, content)

    build_app(workspace: "../TapTap/TapTap.xcworkspace", scheme: "TapTap", export_method: "app-store")
    
    upload_to_app_store(
      api_key: api_key,
      app_identifier: app_identifier,
      app_version: version,
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      skip_app_version_update: true,
      submit_for_review: false,
      run_precheck_before_submit: false
    )

    notify_discord(
      title: "ğŸ“¦ [CI] App Store ì œì¶œ ì™„ë£Œ",
      message: "CIë¥¼ í†µí•œ ì•± ì œì¶œì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.\në²„ì „: #{version} (#{next_build})",
      color: 6377978
    )
  end

  # Discord ì•Œë¦¼ í•¨ìˆ˜
  def notify_discord(params)
    webhook_url = ENV["DISCORD_WEBHOOK_URL"]
    return unless webhook_url

    payload = {
      embeds: [
        {
          title: params[:title],
          description: params[:message],
          color: params[:color] || 3447003,
          timestamp: Time.now.iso8601
        }
      ]
    }

    sh("curl -H 'Content-Type: application/json' -d '#{payload.to_json}' #{webhook_url}")
  end
end

platform :macos do
  desc "íƒ­íƒ­ macOS Development ì¸ì¦ì„œ/í”„ë¡œë¹„ì €ë‹"
  lane :dev do
    match(
      type: "development",
      app_identifier: "com.Nbs.dev.taptap.macOS",
      platform: "macos"
    )
  end

  desc "íƒ­íƒ­ macOS AppStore ì¸ì¦ì„œ/í”„ë¡œë¹„ì €ë‹"
  lane :release do
    match(
      type: "appstore",
      app_identifier: "com.Nbs.dev.ADA.macOS",
      platform: "macos"
    )
  end
end
